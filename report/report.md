./profiler.sh -d 80 -e lock -f hw2lock_get.html 712  
./profiler.sh -d 80 -e lock -f hw2alloc_get.html 712  
./profiler.sh -d 80 -e lock -f hw2cpu_get.html 712

wrk -c 64 -t 3 -d 1m -R 10000 -L -s get.lua http://localhost:8080


wrk -c 64 -t 3 -d 4m -R 20000 -L -s put.lua http://localhost:8080  
root@DESKTOP-E01FUOQ:~/wrk2# wrk -c 64 -t 3 -d 5m -R 10000 -L -s put.lua http://localhost:8080  
Running 5m test @ http://localhost:8080  
3 threads and 64 connections  
Thread calibration: mean lat.: 1.103ms, rate sampling interval: 10ms  
Thread calibration: mean lat.: 1.088ms, rate sampling interval: 10ms  
Thread calibration: mean lat.: 1.097ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     1.36ms    6.09ms 302.34ms   99.57%  
Req/Sec     3.52k   470.77    35.70k    89.83%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    1.07ms  
75.000%    1.48ms  
90.000%    1.85ms  
99.000%    4.44ms  
99.900%   56.77ms  
99.990%  271.61ms  
99.999%  298.49ms  
100.000%  302.59ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.031     0.000000            1         1.00
       0.437     0.100000       290565         1.11
       0.610     0.200000       580967         1.25
       0.768     0.300000       870208         1.43
       0.920     0.400000      1160100         1.67
       1.071     0.500000      1449560         2.00
       1.149     0.550000      1596283         2.22
       1.227     0.600000      1740844         2.50
       1.306     0.650000      1884336         2.86
       1.390     0.700000      2030872         3.33
       1.477     0.750000      2174357         4.00
       1.525     0.775000      2248009         4.44
       1.575     0.800000      2320162         5.00
       1.630     0.825000      2392130         5.71
       1.692     0.850000      2464796         6.67
       1.763     0.875000      2536617         8.00
       1.805     0.887500      2573598         8.89
       1.851     0.900000      2609574        10.00
       1.904     0.912500      2645617        11.43
       1.968     0.925000      2681811        13.33
       2.049     0.937500      2717907        16.00
       2.099     0.943750      2735986        17.78
       2.161     0.950000      2754519        20.00
       2.235     0.956250      2772282        22.86
       2.337     0.962500      2790435        26.67
       2.477     0.968750      2808388        32.00
       2.575     0.971875      2817493        35.56
       2.701     0.975000      2826555        40.00
       2.865     0.978125      2835552        45.71
       3.093     0.981250      2844593        53.33
       3.411     0.984375      2853679        64.00
       3.623     0.985938      2858195        71.11
       3.875     0.987500      2862724        80.00
       4.207     0.989062      2867287        91.43
       4.619     0.990625      2871773       106.67
       5.167     0.992188      2876330       128.00
       5.515     0.992969      2878588       142.22
       5.935     0.993750      2880830       160.00
       6.443     0.994531      2883098       182.86
       7.091     0.995313      2885368       213.33
       7.967     0.996094      2887628       256.00
       8.551     0.996484      2888769       284.44
       9.231     0.996875      2889891       320.00
      10.191     0.997266      2891032       365.71
      11.543     0.997656      2892159       426.67
      13.615     0.998047      2893286       512.00
      15.055     0.998242      2893853       568.89
      16.927     0.998437      2894419       640.00
      19.903     0.998633      2894986       731.43
      27.215     0.998828      2895551       853.33
      62.719     0.999023      2896117      1024.00
      84.415     0.999121      2896401      1137.78
     108.735     0.999219      2896684      1280.00
     132.991     0.999316      2896969      1462.86
     155.647     0.999414      2897250      1706.67
     180.095     0.999512      2897534      2048.00
     192.383     0.999561      2897675      2275.56
     204.927     0.999609      2897816      2560.00
     218.111     0.999658      2897959      2925.71
     230.143     0.999707      2898099      3413.33
     241.663     0.999756      2898241      4096.00
     247.423     0.999780      2898312      4551.11
     253.439     0.999805      2898384      5120.00
     258.303     0.999829      2898453      5851.43
     263.167     0.999854      2898527      6826.67
     267.775     0.999878      2898602      8192.00
     269.567     0.999890      2898632      9102.22
     272.127     0.999902      2898667     10240.00
     273.919     0.999915      2898702     11702.86
     276.479     0.999927      2898740     13653.33
     278.527     0.999939      2898774     16384.00
     280.063     0.999945      2898789     18204.44
     282.623     0.999951      2898807     20480.00
     284.671     0.999957      2898825     23405.71
     287.999     0.999963      2898842     27306.67
     290.303     0.999969      2898860     32768.00
     291.583     0.999973      2898869     36408.89
     293.119     0.999976      2898878     40960.00
     294.143     0.999979      2898887     46811.43
     295.679     0.999982      2898896     54613.33
     296.959     0.999985      2898904     65536.00
     297.471     0.999986      2898909     72817.78
     297.983     0.999988      2898916     81920.00
     298.495     0.999989      2898922     93622.86
     298.495     0.999991      2898922    109226.67
     299.263     0.999992      2898929    131072.00
     299.263     0.999993      2898929    145635.56
     299.519     0.999994      2898932    163840.00
     299.775     0.999995      2898934    187245.71
     300.031     0.999995      2898935    218453.33
     300.543     0.999996      2898937    262144.00
     300.799     0.999997      2898939    291271.11
     301.311     0.999997      2898941    327680.00
     301.311     0.999997      2898941    374491.43
     301.567     0.999998      2898942    436906.67
     301.823     0.999998      2898944    524288.00
     301.823     0.999998      2898944    582542.22
     301.823     0.999998      2898944    655360.00
     302.079     0.999999      2898945    748982.86
     302.079     0.999999      2898945    873813.33
     302.335     0.999999      2898946   1048576.00
     302.335     0.999999      2898946   1165084.44
     302.335     0.999999      2898946   1310720.00
     302.591     0.999999      2898948   1497965.71
     302.591     1.000000      2898948          inf
[Mean    =        1.361, StdDeviation   =        6.087]  
[Max     =      302.336, Total count    =      2898948]  
[Buckets =           27, SubBuckets     =         2048]  
----------------------------------------------------------  
2999519 requests in 5.00m, 191.66MB read  
Requests/sec:   9998.39  
Transfer/sec:    654.19KB    

----


root@DESKTOP-E01FUOQ:~/async-profiler# ./profiler.sh -d 80 -f hw2cpu_get.html 4307  
root@DESKTOP-E01FUOQ:~/async-profiler# ./profiler.sh -d 80 -e alloc -f hw2alloc_get.html 4307  
root@DESKTOP-E01FUOQ:~/async-profiler# ./profiler.sh -d 80 -e lock -f hw2lock_get.html 4307  

#GET

По наполненной базе

root@DESKTOP-E01FUOQ:~/wrk2# wrk -c 64 -t 3 -d 5m -R 10000 -L -s get.lua http://localhost:8080  
Running 5m test @ http://localhost:8080  
3 threads and 64 connections  
Thread calibration: mean lat.: 2.153ms, rate sampling interval: 10ms  
Thread calibration: mean lat.: 2.122ms, rate sampling interval: 10ms  
Thread calibration: mean lat.: 2.241ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     2.75ms   26.67ms 818.69ms   99.58%  
Req/Sec     3.52k   772.74    59.78k    94.70%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    1.15ms  
75.000%    1.60ms  
90.000%    2.08ms  
99.000%   10.69ms  
99.900%  560.13ms  
99.990%  789.50ms  
99.999%  814.08ms  
100.000%  819.20ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.052     0.000000            2         1.00
       0.475     0.100000       289996         1.11
       0.656     0.200000       580280         1.25
       0.822     0.300000       870881         1.43
       0.984     0.400000      1160159         1.67
       1.149     0.500000      1449875         2.00
       1.234     0.550000      1595035         2.22
       1.321     0.600000      1740114         2.50
       1.410     0.650000      1885428         2.86
       1.503     0.700000      2030438         3.33
       1.604     0.750000      2174860         4.00
       1.660     0.775000      2247686         4.44
       1.721     0.800000      2320189         5.00
       1.788     0.825000      2391829         5.71
       1.867     0.850000      2464817         6.67
       1.960     0.875000      2536724         8.00
       2.016     0.887500      2572993         8.89
       2.083     0.900000      2609873        10.00
       2.163     0.912500      2645460        11.43
       2.269     0.925000      2681545        13.33
       2.425     0.937500      2718058        16.00
       2.537     0.943750      2736016        17.78
       2.695     0.950000      2754163        20.00
       2.927     0.956250      2772183        22.86
       3.271     0.962500      2790294        26.67
       3.817     0.968750      2808402        32.00
       4.199     0.971875      2817473        35.56
       4.691     0.975000      2826503        40.00
       5.319     0.978125      2835567        45.71
       6.131     0.981250      2844592        53.33
       7.231     0.984375      2853668        64.00
       7.935     0.985938      2858197        71.11
       8.791     0.987500      2862745        80.00
       9.871     0.989062      2867249        91.43
      11.319     0.990625      2871774       106.67
      13.327     0.992188      2876313       128.00
      14.767     0.992969      2878567       142.22
      16.575     0.993750      2880839       160.00
      19.167     0.994531      2883098       182.86
      23.951     0.995313      2885359       213.33
      36.415     0.996094      2887622       256.00
      55.839     0.996484      2888755       284.44
      97.791     0.996875      2889887       320.00
     133.759     0.997266      2891020       365.71
     218.495     0.997656      2892153       426.67
     317.695     0.998047      2893285       512.00
     367.871     0.998242      2893852       568.89
     417.023     0.998437      2894419       640.00
     466.175     0.998633      2894985       731.43
     516.351     0.998828      2895549       853.33
     566.271     0.999023      2896120      1024.00
     590.847     0.999121      2896400      1137.78
     615.935     0.999219      2896684      1280.00
     640.511     0.999316      2896970      1462.86
     664.063     0.999414      2897250      1706.67
     689.663     0.999512      2897533      2048.00
     703.487     0.999561      2897680      2275.56
     715.775     0.999609      2897817      2560.00
     728.575     0.999658      2897960      2925.71
     740.863     0.999707      2898098      3413.33
     753.151     0.999756      2898246      4096.00
     758.783     0.999780      2898311      4551.11
     764.927     0.999805      2898384      5120.00
     771.071     0.999829      2898456      5851.43
     777.215     0.999854      2898526      6826.67
     783.871     0.999878      2898598      8192.00
     787.455     0.999890      2898638      9102.22
     790.015     0.999902      2898669     10240.00
     793.087     0.999915      2898702     11702.86
     796.159     0.999927      2898735     13653.33
     799.743     0.999939      2898774     16384.00
     801.279     0.999945      2898790     18204.44
     802.815     0.999951      2898809     20480.00
     803.839     0.999957      2898823     23405.71
     805.887     0.999963      2898847     27306.67
     806.911     0.999969      2898867     32768.00
     806.911     0.999973      2898867     36408.89
     807.935     0.999976      2898876     40960.00
     808.959     0.999979      2898885     46811.43
     810.495     0.999982      2898893     54613.33
     812.031     0.999985      2898904     65536.00
     812.543     0.999986      2898910     72817.78
     813.055     0.999988      2898914     81920.00
     814.079     0.999989      2898919     93622.86
     814.591     0.999991      2898925    109226.67
     814.591     0.999992      2898925    131072.00
     815.615     0.999993      2898931    145635.56
     815.615     0.999994      2898931    163840.00
     815.615     0.999995      2898931    187245.71
     816.127     0.999995      2898935    218453.33
     816.127     0.999996      2898935    262144.00
     816.639     0.999997      2898937    291271.11
     817.151     0.999997      2898941    327680.00
     817.151     0.999997      2898941    374491.43
     817.151     0.999998      2898941    436906.67
     817.151     0.999998      2898941    524288.00
     817.663     0.999998      2898943    582542.22
     817.663     0.999998      2898943    655360.00
     817.663     0.999999      2898943    748982.86
     817.663     0.999999      2898943    873813.33
     818.687     0.999999      2898945   1048576.00
     818.687     0.999999      2898945   1165084.44
     818.687     0.999999      2898945   1310720.00
     818.687     0.999999      2898945   1497965.71
     818.687     0.999999      2898945   1747626.67
     818.687     1.000000      2898945   2097152.00
     818.687     1.000000      2898945   2330168.89
     818.687     1.000000      2898945   2621440.00
     819.199     1.000000      2898946   2995931.43
     819.199     1.000000      2898946          inf
[Mean    =        2.751, StdDeviation   =       26.668]  
[Max     =      818.688, Total count    =      2898946]  
[Buckets =           27, SubBuckets     =         2048]  
----------------------------------------------------------  
2999512 requests in 5.00m, 211.33MB read  
Requests/sec:   9998.37  
Transfer/sec:    721.36KB    

#ВЫВОДЫ:

[cpu_put](hw22cpu_put.html)
[alloc_put](hw22alloc_put.html)
[lock_put](hw22lock_put.html)

##Put:
От локов полностью избавиться не получилось, приходится ждать, но ждем когда, заходим на след флаш, а так задача может выполниться быстрее
и ничего лочиться не будет. В профили появился ThreadPool, который показывает, что все таки параллельно что-то работает. Из основго профиля исчезла запись
Так же GC работает больше, м.б связано с тем, что создаем много runnable задач.
3 девятки скорее всего связаны с flush'ом, уже после скорее gc, который тормози все и собирает мусор. Дальше сильного скачка нрет.
Выделение памяти так же увеличилось, теперь создаются объекты при prepareFlush and afterFlush. Но не критично, т.к операция флаш не такая частая.



[cpu_get](hw22cpu_get.html)
[alloc_get](hw22alloc_get.html)
[lock_get](hw22lock_get.html)
##Get:

После убирания synchronize с get, скорость увеличилась, локов больше нет. Основное время нахожднеия все так же в offset,
и в one-nio. Разница между 2мя и 3мя девятками, связана, вероятно, с GC, у которого 2 samples, т.к для 99.90% выполняется быстрее чем 560мс,
остальное может и уходит на GC, если смотреть на профиль, то с другим это и не связано. Так же может быть связано, что долбим врк
с одного и того же устройства.

Оптимизации: для гетов, все так же можно иметь какой-то кэш, с диапазонами, либо с самими ключами, что позволит не 
всегда ходить на диск.



