#Где-то с 271 строки вторая версия.


#jps:
```
99 GradleDaemon
711 Jps
632 GradleWrapperMain
635 -- process information unavailable
685 Server
```

#PUT

##wrk:
```
wrk -c 1 -t 1 -d 10m -R 10000 -L -s put.lua http://localhost:8080
```
##async-profiler:
```
sh profiler.sh -d 60 -f cpu_put.html 685

sh profiler.sh -d 60 -e alloc -f alloc_put.html 685
```
##lua script:

```
counter = 0

request = function()
path = "/v0/entity?id=key" .. counter
wrk.method = "PUT"
wrk.body = "value" .. counter
counter = counter + 1
return wrk.format(nil, path)
end
```
Running 10m test @ http://localhost:8080  
1 threads and 1 connections  
Thread calibration: mean lat.: 47.660ms, rate sampling interval: 267ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency    23.77s    10.36s   44.47s    62.67%  
Req/Sec     9.27k     3.46k   12.12k    86.10%  

Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%   22.54s  
75.000%   31.46s  
90.000%   40.83s  
99.000%   44.27s  
99.900%   44.50s  
99.990%   44.50s  
99.999%   44.50s  
100.000%   44.50s  

Detailed Percentile spectrum:  
|Value      |Percentile    |TotalCount  |     1/(1-Percentile)  
|719.359    |0.000000           34         1.00  
|10706.943  | 0.100000       546641         1.11  
|12959.743  | 0.200000      1092274         1.25  
|18726.911  | 0.300000      1638687         1.43  
|21643.263  | 0.400000      2183715         1.67  
|22544.383  | 0.500000      2728903         2.00  
|23773.183  | 0.550000      3008557         2.22  
|26509.311  | 0.600000      3277107         2.50  
|27443.199  | 0.650000      3549169         2.86  
|28884.991  | 0.700000      3822308         3.33  
|31457.279  | 0.750000      4095216         4.00  
|32161.791  | 0.775000      4233215         4.44  
|32587.775  | 0.800000      4369473         5.00  
|32915.455  | 0.825000      4506644         5.71  
|34209.791  | 0.850000      4640556         6.67  
|36044.799  | 0.875000      4777288         8.00  
|37093.375  | 0.887500      4850211         8.89  
|40828.927  | 0.900000      4911933        10.00  
|41648.127  | 0.912500      4991356        11.43  
|42074.111  | 0.925000      5058918        13.33  
|42336.255  | 0.937500      5120130        16.00  
|42467.327  | 0.943750      5152184        17.78  
|42598.399  | 0.950000      5189196        20.00  
|42729.471  | 0.956250      5219478        22.86  
|42860.543  | 0.962500      5254781        26.67  
|43253.759  | 0.968750      5294511        32.00  
|43286.527  | 0.971875      5307914        35.56  
|43352.063  | 0.975000      5323400        40.00  
|43450.367  | 0.978125      5340569        45.71  
|43515.903  | 0.981250      5362299        53.33  
|43548.671  | 0.984375      5372409        64.00  
|43614.207  | 0.985938      5382699        71.11  
|44204.031  | 0.987500      5397067        80.00  
|44236.799  | 0.989062      5402248        91.43  
|44335.103  | 0.990625      5408593       106.67  
|44367.871  | 0.992188      5424956       128.00  
|44367.871  | 0.992969      5424956       142.22  
|44367.871  | 0.993750      5424956       160.00  
|44400.639  | 0.994531      5433658       182.86  
|44400.639  | 0.995313      5433658       213.33  
|44433.407  | 0.996094      5443519       256.00  
|44433.407  | 0.996484      5443519       284.44  
|44433.407  | 0.996875      5443519       320.00  
|44433.407  | 0.997266      5443519       365.71  
|44466.175  | 0.997656      5448355       426.67  
|44466.175  | 0.998047      5448355       512.00  
|44466.175  | 0.998242      5448355       568.89  
|44498.943  | 0.998437      5457598       640.00  
|44498.943  | 1.000000      5457598          inf  

[Mean    =    23766.927, StdDeviation   =    10357.688]  
[Max     =    44466.176, Total count    =      5457598]  
[Buckets =           27, SubBuckets     =         2048]  
----------------------------------------------------------
5546987 requests in 10.00m, 354.43MB read  
Requests/sec:   9244.56  
Transfer/sec:    604.87KB  

За 10 мин было сделано 5 546 987 запросов, что почти в два раза больше, чем get'ов, это мб связано с тем, 
что для записать элемент проще, чем его искать, тк мы просто его добавляем и иногда происходить flush. А при чтении
надо искать ключи по файлам. Также скорость в секунду также почти в 2 раза больше при добавлении. Так же средняя и 
максимальная задержка ниже, чем при get.

#Результаты профилирования:
###cpu_put
[cpu_put](cpu_put.html)  
На графике можно заметить, что основное время всего выполнение происходит в методе handle request(80.09%),
где обрабатывается put запрос.  
58.99% из всего времени забирает на себя one-nio, которая производит дальше отправку ответа и
пишет в сокет(так же 55.69% времени у нас происходят системные вызовы). 
20.70% времени у нас происходит добавление элементов в хранилище.  
Причем 17.98% времени уходит на flush, и остальное, когда flush не вызывается, происходит добавление в memory 
storage(2.15% времени). При сохранении данных на диск у нас пишутся size + value и value и это 13.28% и 3.19% времени 
соответственно.  
Так же 2.37% времени работает gc, который срабатывает, скорее всего, так как происходит много аллокаций при 
записи(метод writeValue) 

###alloc_put
[cpu_get](alloc_put.html )
52.67% все памяти выделяется в методе handleRequest, происходит сама аллокация в методе put.  
Дальше уже при upsert у нас выделяется память на сами record'ы, так же при получении getKey,
getValue так же происходит аллокация для неизменяемости, и дальше как было предположено выше
при записи(writeValue).

***

#GET

##wrk: 
```
wrk -c 1 -t 1 -d 10m -R 10000 -L -s get.lua http://localhost:8080
```

##async-profiler:
```
sh profiler.sh -d 60 -f cpu_get.html 685

sh profiler.sh -d 60 -e alloc -f alloc_get.html 685
```
##lua script:
```
counter = 0

request = function()
path = "/v0/entity?id=key" .. counter
wrk.method = "GET"
counter = counter + 1
return wrk.format(nil, path)
end
```
Running 10m test @ http://localhost:8080  
1 threads and 1 connections  
Thread calibration: mean lat.: 2775.705ms, rate sampling interval: 9215m  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     2.41m     1.43m    5.41m    60.65%  
Req/Sec     4.58k   783.40     5.48k    73.44%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    2.31m  
75.000%    3.55m  
90.000%    4.36m  
99.000%    5.32m  
99.900%    5.40m  
99.990%    5.41m  
99.999%    5.41m  
100.000%    5.41m  

Detailed Percentile spectrum:  
Value          Percentile   TotalCount       1/(1-Percentile)  

5099.519       0.000000            1         1.00  
32702.463      0.100000       270410         1.11  
57638.911      0.200000       541025         1.25  
82182.143      0.300000       811226         1.43  
110755.839     0.400000      1081732         1.67  
138412.031     0.500000      1352307         2.00  
152567.807     0.550000      1487285         2.22  
170917.887     0.600000      1623044         2.50  
185466.879     0.650000      1757597         2.86  
200146.943     0.700000      1893535         3.33  
212860.927     0.750000      2028249         4.00  
220200.959     0.775000      2095721         4.44  
227147.775     0.800000      2163594         5.00  
234356.735     0.825000      2230649         5.71  
241303.551     0.850000      2298739         6.67  
248774.655     0.875000      2366137         8.00  
255197.183     0.887500      2399544         8.89  
261881.855     0.900000      2433507        10.00  
271056.895     0.912500      2467852        11.43  
279183.359     0.925000      2501703        13.33  
286785.535     0.937500      2534658        16.00  
290717.695     0.943750      2551893        17.78  
294649.855     0.950000      2568474        20.00  
298582.015     0.956250      2585383        22.86  
302252.031     0.962500      2602864        26.67  
306446.335     0.968750      2619746        32.00  
308543.487     0.971875      2628444        35.56  
310378.495     0.975000      2636630        40.00  
312213.503     0.978125      2645093        45.71  
314048.511     0.981250      2653555        53.33  
315883.519     0.984375      2662004        64.00  
316669.951     0.985938      2665639        71.11  
317718.527     0.987500      2670320        80.00  
318767.103     0.989062      2675057        91.43  
319553.535     0.990625      2678517       106.67  
320339.967     0.992188      2682419       128.00  
320864.255     0.992969      2685021       142.22  
321388.543     0.993750      2687680       160.00  
321650.687     0.994531      2689084       182.86  
322174.975     0.995313      2691559       213.33  
322699.263     0.996094      2693690       256.00  
322961.407     0.996484      2694845       284.44  
323223.551     0.996875      2696086       320.00  
323223.551     0.997266      2696086       365.71  
323485.695     0.997656      2697343       426.67  
323747.839     0.998047      2698709       512.00  
323747.839     0.998242      2698709       568.89  
324009.983     0.998437      2700047       640.00  
324009.983     0.998633      2700047       731.43  
324272.127     0.998828      2701419       853.33  
324272.127     0.999023      2701419      1024.00  
324272.127     0.999121      2701419      1137.78  
324272.127     0.999219      2701419      1280.00  
324534.271     0.999316      2702399      1462.86  
324534.271     0.999414      2702399      1706.67  
324534.271     0.999512      2702399      2048.00  
324534.271     0.999561      2702399      2275.56  
324534.271     0.999609      2702399      2560.00  
324796.415     0.999658      2703433      2925.71  
324796.415     1.000000      2703433          inf  

[Mean    =   144368.832, StdDeviation   =    85588.639]  
[Max     =   324534.272, Total count    =      2703433]  
[Buckets =           27, SubBuckets     =         2048]  

2752496 requests in 10.00m, 193.91MB read  
Requests/sec:   4587.49  
Transfer/sec:    330.93KB  

#Результаты профилирования:
###cpu_get
[cpu_get](cpu_get.html)
Тут же one-nie забирает 21.31% и 3.29%, все же остальное время у нас когда мы получаем range и
когда итерируем до следующего элемента, для получения значений [from, to). При чем merge срабатывает не очень часто,
т.к не очень много создается файлов, и в основном бегаем по файлам бинарным поиском для получения 
позиции для начала чтения(57.52%).  
Так же 2.55% работает gc.

###alloc_get 
[alloc_get](alloc_get.html)

78.93% всей памяти выделяется при получении range, когда бегаем по файлам и ищем ключ с которого читать. В основном,
они происходят в SSTable итератор, т.к часто там читаем из файла, для чего выделяем память, чтобы получить следующий ключ.

----------------------------------------------------------------
#Second try

#PUT
wrk -c 1 -t 1 -d 12m -R 2000 -L -s put.lua http://localhost:8080

./profiler.sh -d 300 -f cpu3_put.html 712  
./profiler.sh -d 300 -e alloc -f alloc3_put.html 712  

root@DESKTOP-E01FUOQ:~/wrk2# wrk -c 1 -t 1 -d 12m -R 2000 -L -s put.lua http://localhost:8080  
Running 12m test @ http://localhost:8080  
1 threads and 1 connections  
Thread calibration: mean lat.: 1.427ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency    28.06ms  159.26ms   2.27s    96.55%  
Req/Sec     2.12k     0.87k   13.67k    94.67%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    1.17ms  
75.000%    1.65ms  
90.000%    2.07ms  
99.000%  901.12ms  
99.900%    1.85s  
99.990%    2.22s  
99.999%    2.27s  
100.000%    2.27s  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.068     0.000000            1         1.00
       0.415     0.100000       142183         1.11
       0.659     0.200000       284544         1.25
       0.881     0.300000       426088         1.43
       1.039     0.400000       568348         1.67
       1.168     0.500000       710106         2.00
       1.235     0.550000       781926         2.22
       1.310     0.600000       852450         2.50
       1.411     0.650000       923414         2.86
       1.527     0.700000       994423         3.33
       1.650     0.750000      1065526         4.00
       1.713     0.775000      1100764         4.44
       1.778     0.800000      1136450         5.00
       1.843     0.825000      1171980         5.71
       1.911     0.850000      1207440         6.67
       1.984     0.875000      1242843         8.00
       2.024     0.887500      1260276         8.89
       2.071     0.900000      1278107        10.00
       2.141     0.912500      1295872        11.43
       2.377     0.925000      1313502        13.33
       3.349     0.937500      1331257        16.00
       4.643     0.943750      1340139        17.78
       7.291     0.950000      1349003        20.00
      16.879     0.956250      1357869        22.86
     108.287     0.962500      1366751        26.67
     278.783     0.968750      1375626        32.00
     363.775     0.971875      1380069        35.56
     450.815     0.975000      1384499        40.00
     543.231     0.978125      1388953        45.71
     635.391     0.981250      1393384        53.33
     728.575     0.984375      1397811        64.00
     777.215     0.985938      1400030        71.11
     825.855     0.987500      1402265        80.00
     870.911     0.989062      1404470        91.43
     924.671     0.990625      1406697       106.67
     979.455     0.992188      1408919       128.00
    1010.175     0.992969      1410018       142.22
    1060.863     0.993750      1411121       160.00
    1133.567     0.994531      1412235       182.86
    1228.799     0.995313      1413344       213.33
    1336.319     0.996094      1414455       256.00
    1387.519     0.996484      1415002       284.44
    1439.743     0.996875      1415557       320.00
    1492.991     0.997266      1416111       365.71
    1545.215     0.997656      1416668       426.67
    1600.511     0.998047      1417224       512.00
    1631.231     0.998242      1417500       568.89
    1687.551     0.998437      1417776       640.00
    1742.847     0.998633      1418056       731.43
    1798.143     0.998828      1418329       853.33
    1854.463     0.999023      1418610      1024.00
    1882.111     0.999121      1418747      1137.78
    1908.735     0.999219      1418884      1280.00
    1935.359     0.999316      1419027      1462.86
    1963.007     0.999414      1419162      1706.67
    2000.895     0.999512      1419301      2048.00
    2028.543     0.999561      1419369      2275.56
    2054.143     0.999609      1419439      2560.00
    2082.815     0.999658      1419509      2925.71
    2111.487     0.999707      1419580      3413.33
    2140.159     0.999756      1419651      4096.00
    2152.447     0.999780      1419683      4551.11
    2164.735     0.999805      1419716      5120.00
    2179.071     0.999829      1419756      5851.43
    2191.359     0.999854      1419786      6826.67
    2205.695     0.999878      1419820      8192.00
    2211.839     0.999890      1419837      9102.22
    2217.983     0.999902      1419855     10240.00
    2224.127     0.999915      1419872     11702.86
    2230.271     0.999927      1419890     13653.33
    2238.463     0.999939      1419911     16384.00
    2240.511     0.999945      1419915     18204.44
    2244.607     0.999951      1419926     20480.00
    2248.703     0.999957      1419936     23405.71
    2252.799     0.999963      1419945     27306.67
    2254.847     0.999969      1419950     32768.00
    2256.895     0.999973      1419955     36408.89
    2258.943     0.999976      1419960     40960.00
    2260.991     0.999979      1419965     46811.43
    2263.039     0.999982      1419970     54613.33
    2265.087     0.999985      1419975     65536.00
    2265.087     0.999986      1419975     72817.78
    2267.135     0.999988      1419980     81920.00
    2267.135     0.999989      1419980     93622.86
    2267.135     0.999991      1419980    109226.67
    2269.183     0.999992      1419986    131072.00
    2269.183     0.999993      1419986    145635.56
    2269.183     0.999994      1419986    163840.00
    2269.183     0.999995      1419986    187245.71
    2271.231     0.999995      1419992    218453.33
    2271.231     0.999996      1419992    262144.00
    2271.231     0.999997      1419992    291271.11
    2271.231     0.999997      1419992    327680.00
    2271.231     0.999997      1419992    374491.43
    2271.231     0.999998      1419992    436906.67
    2271.231     0.999998      1419992    524288.00
    2271.231     0.999998      1419992    582542.22
    2271.231     0.999998      1419992    655360.00
    2271.231     0.999999      1419992    748982.86
    2271.231     0.999999      1419992    873813.33
    2271.231     0.999999      1419992   1048576.00
    2271.231     0.999999      1419992   1165084.44
    2271.231     0.999999      1419992   1310720.00
    2273.279     0.999999      1419993   1497965.71
    2273.279     1.000000      1419993          inf
[Mean    =       28.060, StdDeviation   =      159.256]  
[Max     =     2271.232, Total count    =      1419993]  
[Buckets =           27, SubBuckets     =         2048]  
----------------------------------------------------------
1439999 requests in 12.00m, 92.01MB read  
Requests/sec:   2000.00  
Transfer/sec:    130.86KB  


###cpu_put
[cpu2_put](secondTryProfiler/cpu3_put.html)


###alloc_put
[alloc2_put](secondTryProfiler/alloc3_put.html)

Выводы:  
Был снижен rate, т.к сервис не выдерживал. Было увеличено время нагрузочного тестирования, чтобы застать flush'и.  
Из таблицы, выданной от wrk видно, что разница задержки от 50% до 90% практически незаметна, но уже между 90% и 99% происходит   
сильный скачок. Т.е 99% запросов выполняются быстрее 901.12мс, остальной процент дольше, и это скорее всего связано со flush'ем,
т.к на графике он занимает 11%.  
Между 99% и 99.9% тоже большой скачок, в 2 раза. Это может быть связано с GC, тк при его работе, он на какое-то время останавливает
выполнение программы и собирает мусор. На графике, где представлены результат профилирования видно, что GC работает 5% времени.
От 99.9% до 100% разброс незаметен, и это соответствует всему тому, что указано выше.  

Из графика alloc_put можно увидеть, что в методе upsert 133 раза(3.61%) берется getKey из sizeOf, хотя flush'ей было гораздо 
меньше. Вместо обнуления и прибавления нового размера, можно сразу задавать новый размер и вызывать sizeOf 1 раз, 
это уменьшит аллоцирование памяти, т.к мы всегда берем копию(это конечно не сильно что-то изменит, но все же).  

Можно уменьшит в методе выделение памяти, где создается ByteBuffer size, чтобы один раз аллоцировать память(вынести в 
переменные класса) и просто его опустошать, но если дальше будет флаш в 
другом потоке, то т.к один bytebuffer, то он должен будет быть потокобезопасным, т.к вынесем из локальных переменных, и 
она не будет уникальной у каждого потока.  

Так же можно уменьшить аллоцирование ByteBuffer value = record.getValue() == null, которое занимает 3.50% 
времени(просто проверяя на tombstone).  

Так же убрать лишнюю аллокацию в writeValue.  

Так же присутствуют аллокаци, когда получаем key, value, но убрав их, мы перестанем получать неизменяемые обьекты
(не будем получать копии).  



-----
#GET

wrk -c 1 -t 1 -d 12m -R 3000 -L -s get.lua http://localhost:8080

./profiler.sh -d 300 -f cpu3_get.html 712
./profiler.sh -d 300 -e alloc -f alloc3_get.html 712


root@DESKTOP-E01FUOQ:~/wrk2# wrk -c 1 -t 1 -d 12m -R 3000 -L -s get.lua http://localhost:8080  
Running 12m test @ http://localhost:8080  
1 threads and 1 connections  
Thread calibration: mean lat.: 14.287ms, rate sampling interval: 32ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency    12.92ms  132.85ms   2.52s    99.16%  
Req/Sec     3.06k   531.44     9.39k    87.62%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    1.07ms  
75.000%    1.64ms  
90.000%    6.17ms  
99.000%  105.73ms  
99.900%    2.32s  
99.990%    2.50s  
99.999%    2.51s  
100.000%    2.52s  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)

       0.051     0.000000            2         1.00
       0.366     0.100000       213993         1.11
       0.554     0.200000       426015         1.25
       0.737     0.300000       639823         1.43
       0.911     0.400000       852639         1.67
       1.071     0.500000      1066054         2.00
       1.143     0.550000      1172349         2.22
       1.213     0.600000      1278373         2.50
       1.289     0.650000      1384771         2.86
       1.415     0.700000      1491427         3.33
       1.640     0.750000      1597497         4.00
       1.772     0.775000      1650759         4.44
       1.915     0.800000      1704212         5.00
       2.077     0.825000      1757278         5.71
       2.493     0.850000      1810608         6.67
       3.945     0.875000      1863773         8.00
       4.963     0.887500      1890440         8.89
       6.167     0.900000      1917086        10.00
       7.567     0.912500      1943655        11.43
       9.071     0.925000      1970292        13.33
      11.023     0.937500      1996947        16.00
      12.247     0.943750      2010219        17.78
      13.687     0.950000      2023551        20.00
      15.495     0.956250      2036843        22.86
      17.775     0.962500      2050144        26.67
      20.463     0.968750      2063444        32.00
      22.159     0.971875      2070103        35.56
      24.303     0.975000      2076741        40.00
      26.911     0.978125      2083414        45.71
      30.367     0.981250      2090059        53.33
      36.895     0.984375      2096711        64.00
      44.415     0.985938      2100044        71.11
      60.639     0.987500      2103366        80.00
      85.247     0.989062      2106698        91.43
     117.247     0.990625      2110023       106.67
     167.167     0.992188      2113349       128.00
     241.023     0.992969      2115012       142.22
     382.975     0.993750      2116676       160.00
     643.071     0.994531      2118342       182.86
     968.703     0.995313      2120004       213.33
    1299.455     0.996094      2121669       256.00
    1470.463     0.996484      2122504       284.44
    1617.919     0.996875      2123334       320.00
    1762.303     0.997266      2124165       365.71
    1898.495     0.997656      2124999       426.67
    1999.871     0.998047      2125836       512.00
    2061.311     0.998242      2126244       568.89
    2123.775     0.998437      2126667       640.00
    2189.311     0.998633      2127082       731.43
    2250.751     0.998828      2127494       853.33
    2326.527     0.999023      2127914      1024.00
    2349.055     0.999121      2128143      1137.78
    2365.439     0.999219      2128340      1280.00
    2394.111     0.999316      2128545      1462.86
    2420.735     0.999414      2128784      1706.67
    2437.119     0.999512      2128993      2048.00
    2441.215     0.999561      2129072      2275.56
    2449.407     0.999609      2129166      2560.00
    2457.599     0.999658      2129274      2925.71
    2467.839     0.999707      2129369      3413.33
    2473.983     0.999756      2129468      4096.00
    2480.127     0.999780      2129525      4551.11
    2484.223     0.999805      2129581      5120.00
    2486.271     0.999829      2129627      5851.43
    2490.367     0.999854      2129701      6826.67
    2494.463     0.999878      2129745      8192.00
    2496.511     0.999890      2129774      9102.22
    2498.559     0.999902      2129822     10240.00
    2498.559     0.999915      2129822     11702.86
    2500.607     0.999927      2129868     13653.33
    2500.607     0.999939      2129868     16384.00
    2502.655     0.999945      2129901     18204.44
    2502.655     0.999951      2129901     20480.00
    2502.655     0.999957      2129901     23405.71
    2504.703     0.999963      2129923     27306.67
    2504.703     0.999969      2129923     32768.00
    2506.751     0.999973      2129944     36408.89
    2506.751     0.999976      2129944     40960.00
    2506.751     0.999979      2129944     46811.43
    2508.799     0.999982      2129952     54613.33
    2510.847     0.999985      2129960     65536.00
    2510.847     0.999986      2129960     72817.78
    2512.895     0.999988      2129968     81920.00
    2512.895     0.999989      2129968     93622.86
    2514.943     0.999991      2129975    109226.67
    2514.943     0.999992      2129975    131072.00
    2514.943     0.999993      2129975    145635.56
    2514.943     0.999994      2129975    163840.00
    2516.991     0.999995      2129983    187245.71
    2516.991     0.999995      2129983    218453.33
    2516.991     0.999996      2129983    262144.00
    2516.991     0.999997      2129983    291271.11
    2516.991     0.999997      2129983    327680.00
    2516.991     0.999997      2129983    374491.43
    2519.039     0.999998      2129988    436906.67
    2519.039     1.000000      2129988          inf
[Mean    =       12.917, StdDeviation   =      132.854]  
[Max     =     2516.992, Total count    =      2129988]  
[Buckets =           27, SubBuckets     =         2048]  
----------------------------------------------------------
2159996 requests in 12.00m, 150.41MB read  
Non-2xx or 3xx responses: 269240  
Requests/sec:   2999.99  
Transfer/sec:    213.91KB  

###cpu_get
[cpu2_get](secondTryProfiler/cpu3_get.html)


###alloc_get
[alloc2_get](secondTryProfiler/alloc3_get.html)
Выводы:  
Был снижен rate, т.к сервис не выдерживал. При get первый значительный скачок происходит тоже на 99%. 
Рассматривая cpu_get 26%(остальное время занимает one-nie и с этим ничего не сделать) времени работает readFromFile, 
и по графику памяти тоже видно, что там выделяется большая часть памяти,
т.к у нас  не помещается все в память, приходится все сначала писать на диск, а потом читать, и кажется,
от этого никак не избавится, в нашем случае(это основные операции, которые и должны выполняться дольше всего и выделять 
память для буферов для чтения). Можно убрать некоторые аллокации, как написано ниже. Она останется в next, но без этого 
никак, т.к ищется только ключ с которого читать, и дальше уже сравнивается, чтобы вернуть правильный диапазон, можно и 
искать и ключ до которого читать, но кажется, что это не сильно что-то изменит, т.к все равно будем выделять память при 
чтении, пропадет только аллокация в SStableIterator.

Рассматривя alloc_get, можно заметить, что 27% всей памяти выделяется в итераторах. И большая часть в SStableIterator,
смотря на код, можно убрать некоторые аллокации, например проверку на hasNext в next, и аллоцирование памяти при проверки 
hasNext.



#После изменений, которые были описаны выше, получились следующие графики:

###new_cpu_put
[cpu2_put](secondTryProfiler/cpuRew_put.html)


###new_alloc_put
[alloc2_put](secondTryProfiler/allocRew_put.html)

###new_cpu_get
[cpu2_put](secondTryProfiler/cpuRew_get.html)


###new_alloc_get
[alloc2_put](secondTryProfiler/allocRew_get.html)

wrk -c 1 -t 1 -d 12m -R 2000 -L -s put.lua http://localhost:8080  
Running 12m test @ http://localhost:8080  
1 threads and 1 connections  
Thread calibration: mean lat.: 1.479ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency    25.48ms  168.08ms   1.99s    97.56%  
Req/Sec     2.11k   748.06    13.56k    97.08%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    1.14ms  
75.000%    1.57ms  
90.000%    1.94ms  
99.000%    1.13s  
99.900%    1.72s  
99.990%    1.94s  
99.999%    1.98s  
100.000%    1.99s  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.061     0.000000            1         1.00
       0.396     0.100000       142358         1.11
       0.629     0.200000       284034         1.25
       0.853     0.300000       426178         1.43
       1.017     0.400000       568412         1.67
       1.140     0.500000       710998         2.00
       1.201     0.550000       782104         2.22
       1.265     0.600000       852115         2.50
       1.346     0.650000       923405         2.86
       1.454     0.700000       994375         3.33
       1.568     0.750000      1065016         4.00
       1.629     0.775000      1101018         4.44
       1.690     0.800000      1136464         5.00
       1.751     0.825000      1171544         5.71
       1.812     0.850000      1207254         6.67
       1.874     0.875000      1242762         8.00
       1.906     0.887500      1260258         8.89
       1.940     0.900000      1278318        10.00
       1.974     0.912500      1295801        11.43
       2.010     0.925000      1313526        13.33
       2.051     0.937500      1331769        16.00
       2.073     0.943750      1340271        17.78
       2.101     0.950000      1349548        20.00
       2.135     0.956250      1357957        22.86
       2.217     0.962500      1366816        26.67
       2.955     0.968750      1375629        32.00
       6.799     0.971875      1380056        35.56
     157.951     0.975000      1384497        40.00
     360.191     0.978125      1388936        45.71
     562.687     0.981250      1393376        53.33
     763.391     0.984375      1397809        64.00
     864.767     0.985938      1400027        71.11
     966.143     0.987500      1402245        80.00
    1067.007     0.989062      1404470        91.43
    1166.335     0.990625      1406683       106.67
    1266.687     0.992188      1408904       128.00
    1315.839     0.992969      1410013       142.22
    1366.015     0.993750      1411119       160.00
    1417.215     0.994531      1412245       182.86
    1466.367     0.995313      1413353       213.33
    1516.543     0.996094      1414464       256.00
    1540.095     0.996484      1415022       284.44
    1562.623     0.996875      1415573       320.00
    1584.127     0.997266      1416126       365.71
    1614.847     0.997656      1416681       426.67
    1646.591     0.998047      1417225       512.00
    1660.927     0.998242      1417510       568.89
    1670.143     0.998437      1417781       640.00
    1687.551     0.998633      1418064       731.43
    1703.935     0.998828      1418332       853.33
    1720.319     0.999023      1418618      1024.00
    1728.511     0.999121      1418748      1137.78
    1737.727     0.999219      1418891      1280.00
    1745.919     0.999316      1419026      1462.86
    1755.135     0.999414      1419170      1706.67
    1771.519     0.999512      1419302      2048.00
    1784.831     0.999561      1419372      2275.56
    1796.095     0.999609      1419443      2560.00
    1809.407     0.999658      1419512      2925.71
    1831.935     0.999707      1419577      3413.33
    1859.583     0.999756      1419647      4096.00
    1873.919     0.999780      1419682      4551.11
    1888.255     0.999805      1419718      5120.00
    1900.543     0.999829      1419752      5851.43
    1913.855     0.999854      1419785      6826.67
    1928.191     0.999878      1419821      8192.00
    1935.359     0.999890      1419838      9102.22
    1942.527     0.999902      1419856     10240.00
    1949.695     0.999915      1419874     11702.86
    1955.839     0.999927      1419890     13653.33
    1961.983     0.999939      1419908     16384.00
    1965.055     0.999945      1419916     18204.44
    1968.127     0.999951      1419925     20480.00
    1971.199     0.999957      1419935     23405.71
    1973.247     0.999963      1419944     27306.67
    1975.295     0.999969      1419951     32768.00
    1976.319     0.999973      1419954     36408.89
    1978.367     0.999976      1419960     40960.00
    1979.391     0.999979      1419963     46811.43
    1980.415     0.999982      1419967     54613.33
    1982.463     0.999985      1419974     65536.00
    1982.463     0.999986      1419974     72817.78
    1983.487     0.999988      1419978     81920.00
    1983.487     0.999989      1419978     93622.86
    1984.511     0.999991      1419981    109226.67
    1985.535     0.999992      1419984    131072.00
    1985.535     0.999993      1419984    145635.56
    1986.559     0.999994      1419988    163840.00
    1986.559     0.999995      1419988    187245.71
    1986.559     0.999995      1419988    218453.33
    1986.559     0.999996      1419988    262144.00
    1987.583     0.999997      1419991    291271.11
    1987.583     0.999997      1419991    327680.00
    1987.583     0.999997      1419991    374491.43
    1987.583     0.999998      1419991    436906.67
    1987.583     0.999998      1419991    524288.00
    1987.583     0.999998      1419991    582542.22
    1987.583     0.999998      1419991    655360.00
    1988.607     0.999999      1419993    748982.86
    1988.607     1.000000      1419993          inf
[Mean    =       25.476, StdDeviation   =      168.075]  
[Max     =     1987.584, Total count    =      1419993]  
[Buckets =           27, SubBuckets     =         2048]  
----------------------------------------------------------
1440000 requests in 12.00m, 92.01MB read  
Requests/sec:   2000.00  
Transfer/sec:    130.86KB  

____


wrk -c 1 -t 1 -d 12m -R 3000 -L -s get.lua http://localhost:8080  
Running 12m test @ http://localhost:8080  
1 threads and 1 connections  
Thread calibration: mean lat.: 5.069ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     1.37ms    1.71ms  45.57ms   95.56%  
Req/Sec     3.17k   439.56     8.89k    82.82%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    1.07ms  
75.000%    1.50ms  
90.000%    2.02ms  
99.000%   10.50ms  
99.900%   15.64ms  
99.990%   27.20ms  
99.999%   42.08ms  
100.000%   45.60ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.074     0.000000            1         1.00
       0.362     0.100000       213357         1.11
       0.556     0.200000       426496         1.25
       0.741     0.300000       639285         1.43
       0.916     0.400000       852367         1.67
       1.073     0.500000      1065955         2.00
       1.141     0.550000      1171587         2.22
       1.203     0.600000      1278443         2.50
       1.268     0.650000      1384659         2.86
       1.355     0.700000      1491578         3.33
       1.500     0.750000      1597943         4.00
       1.579     0.775000      1650989         4.44
       1.660     0.800000      1704242         5.00
       1.745     0.825000      1757380         5.71
       1.833     0.850000      1810955         6.67
       1.924     0.875000      1863777         8.00
       1.972     0.887500      1890715         8.89
       2.021     0.900000      1917122        10.00
       2.077     0.912500      1944423        11.43
       2.137     0.925000      1970998        13.33
       2.211     0.937500      1997287        16.00
       2.263     0.943750      2010401        17.78
       2.445     0.950000      2023499        20.00
       3.175     0.956250      2036824        22.86
       4.279     0.962500      2050148        26.67
       5.607     0.968750      2063431        32.00
       6.327     0.971875      2070080        35.56
       7.067     0.975000      2076759        40.00
       7.771     0.978125      2083416        45.71
       8.495     0.981250      2090096        53.33
       9.207     0.984375      2096751        64.00
       9.551     0.985938      2100055        71.11
       9.887     0.987500      2103385        80.00
      10.271     0.989062      2106710        91.43
      10.655     0.990625      2110054       106.67
      11.063     0.992188      2113363       128.00
      11.303     0.992969      2115025       142.22
      11.551     0.993750      2116677       160.00
      11.831     0.994531      2118335       182.86
      12.135     0.995313      2120031       213.33
      12.479     0.996094      2121692       256.00
      12.679     0.996484      2122528       284.44
      12.879     0.996875      2123352       320.00
      13.103     0.997266      2124171       365.71
      13.407     0.997656      2124991       426.67
      13.791     0.998047      2125825       512.00
      14.039     0.998242      2126240       568.89
      14.303     0.998437      2126654       640.00
      14.607     0.998633      2127071       731.43
      15.047     0.998828      2127493       853.33
      15.751     0.999023      2127902      1024.00
      16.223     0.999121      2128115      1137.78
      16.687     0.999219      2128318      1280.00
      17.279     0.999316      2128527      1462.86
      18.047     0.999414      2128742      1706.67
      19.071     0.999512      2128945      2048.00
      19.551     0.999561      2129052      2275.56
      20.015     0.999609      2129151      2560.00
      20.479     0.999658      2129254      2925.71
      21.279     0.999707      2129358      3413.33
      22.319     0.999756      2129462      4096.00
      22.927     0.999780      2129514      4551.11
      23.503     0.999805      2129567      5120.00
      24.159     0.999829      2129618      5851.43
      24.911     0.999854      2129672      6826.67
      25.951     0.999878      2129722      8192.00
      26.479     0.999890      2129748      9102.22
      27.327     0.999902      2129774     10240.00
      28.079     0.999915      2129800     11702.86
      28.719     0.999927      2129826     13653.33
      31.055     0.999939      2129852     16384.00
      32.255     0.999945      2129865     18204.44
      33.503     0.999951      2129878     20480.00
      34.911     0.999957      2129891     23405.71
      35.807     0.999963      2129904     27306.67
      36.767     0.999969      2129917     32768.00
      37.471     0.999973      2129924     36408.89
      38.079     0.999976      2129930     40960.00
      38.783     0.999979      2129937     46811.43
      39.391     0.999982      2129943     54613.33
      40.159     0.999985      2129950     65536.00
      40.447     0.999986      2129953     72817.78
      41.023     0.999988      2129956     81920.00
      41.887     0.999989      2129960     93622.86
      42.399     0.999991      2129963    109226.67
      43.007     0.999992      2129966    131072.00
      43.359     0.999993      2129968    145635.56
      43.551     0.999994      2129969    163840.00
      43.999     0.999995      2129971    187245.71
      44.383     0.999995      2129973    218453.33
      44.479     0.999996      2129975    262144.00
      44.479     0.999997      2129975    291271.11
      44.607     0.999997      2129976    327680.00
      44.799     0.999997      2129977    374491.43
      44.959     0.999998      2129978    436906.67
      44.959     0.999998      2129978    524288.00
      45.151     0.999998      2129979    582542.22
      45.151     0.999998      2129979    655360.00
      45.375     0.999999      2129980    748982.86
      45.375     0.999999      2129980    873813.33
      45.375     0.999999      2129980   1048576.00
      45.567     0.999999      2129981   1165084.44
      45.567     0.999999      2129981   1310720.00
      45.567     0.999999      2129981   1497965.71
      45.567     0.999999      2129981   1747626.67
      45.567     1.000000      2129981   2097152.00
      45.599     1.000000      2129982   2330168.89
      45.599     1.000000      2129982          inf
[Mean    =        1.373, StdDeviation   =        1.711]   
[Max     =       45.568, Total count    =      2129982]  
[Buckets =           27, SubBuckets     =         2048]  
----------------------------------------------------------
2159996 requests in 12.00m, 150.61MB read  
Non-2xx or 3xx responses: 327397  
Requests/sec:   3000.00  
Transfer/sec:    214.20KB  




Итоги:  

Из графиков видно, что cpuPut практически не изменились, но там ничего не изменялось, есть изменения в allocPut,
в котором изменилось количество аллокаций с 13% до 6%. Так же почти на 10% изменилось cpuGet.  
Самые большие изменения, произошли в allocGet, где гораздно снизилось аллокация памяти, когда она много аллоцировалась 
в итераторе SStable(28% против 5%, если конечно эти результаты правильнов все показывают).

Так же видно, что get стал работать гораздо быстрее, повлиять могло как раз таки то, что нет лишних аллокаций и проверок 
в итераторе.

Из того, что не сделано: видно, что поиск по файлам занимает большую часть времени, и если сейчас по скрипту ищем
разные ключи, то если будем искать одни и те же, то это как-то да можно оптимизировать(например как-то кэшировать значения, 
которые часто запрашиваются по одному, либо кэшировать какой-то диапазон ключей, по которому часто ищут).  
Так же сейчас, у нас файлы не компактятся, что тоже может влиять. Можно добавить флаг, по которому будет срабатывать компакт,
по идее это должно как-то да тоже быть оптимизацией(т.к бинарный поиск будет один раз искать ключ с которого читать, 
если один файл).  
Распараллеливать(было сказано на лекции).  
Так же так как, читаем все с одного места, может теряться производительность, имея реплики, можно ускорить процесс, читая не все с одного места,
а с реплик.


