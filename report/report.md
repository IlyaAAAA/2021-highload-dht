./profiler.sh -d 90 -e lock -f hw3lock_put.html 712  
./profiler.sh -d 90 -e alloc -f hw3alloc_put.html 712  
./profiler.sh -d 90 -f hw3cpu_put.html 712

wrk -c 64 -t 3 -d 1m -R 10000 -L -s get.lua http://localhost:8080

root@DESKTOP-E01FUOQ:~/wrk2# wrk -c 120 -t 3 -d 2m -R 20000 -L -s put.lua http://localhost:8080  
Running 2m test @ http://localhost:8080  
3 threads and 120 connections    
Thread calibration: mean lat.: 1.673ms, rate sampling interval: 10ms  
Thread calibration: mean lat.: 1.606ms, rate sampling interval: 10ms  
Thread calibration: mean lat.: 1.698ms, rate sampling interval: 10ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     1.48ms    1.53ms  33.63ms   93.44%  
Req/Sec     7.04k     1.07k   23.67k    87.62%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    1.17ms  
75.000%    1.65ms  
90.000%    2.30ms  
99.000%    8.47ms  
99.900%   16.38ms  
99.990%   25.26ms  
99.999%   30.42ms  
100.000%   33.66ms

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)

       0.051     0.000000            2         1.00
       0.479     0.100000       219778         1.11
       0.670     0.200000       439942         1.25
       0.839     0.300000       659006         1.43
       1.004     0.400000       879198         1.67
       1.174     0.500000      1098024         2.00
       1.263     0.550000      1208529         2.22
       1.354     0.600000      1318614         2.50
       1.448     0.650000      1428021         2.86
       1.545     0.700000      1537396         3.33
       1.651     0.750000      1647942         4.00
       1.709     0.775000      1702024         4.44
       1.775     0.800000      1757093         5.00
       1.853     0.825000      1811859         5.71
       1.951     0.850000      1866926         6.67
       2.089     0.875000      1922025         8.00
       2.181     0.887500      1949085         8.89
       2.303     0.900000      1976558        10.00
       2.475     0.912500      2004069        11.43
       2.731     0.925000      2031312        13.33
       3.125     0.937500      2058749        16.00
       3.389     0.943750      2072512        17.78
       3.701     0.950000      2086263        20.00
       4.071     0.956250      2099964        22.86
       4.527     0.962500      2113702        26.67
       5.079     0.968750      2127419        32.00
       5.403     0.971875      2134275        35.56
       5.759     0.975000      2141141        40.00
       6.167     0.978125      2148016        45.71
       6.627     0.981250      2154880        53.33
       7.167     0.984375      2161716        64.00
       7.471     0.985938      2165117        71.11
       7.819     0.987500      2168575        80.00
       8.207     0.989062      2171997        91.43
       8.679     0.990625      2175468       106.67
       9.239     0.992188      2178882       128.00
       9.567     0.992969      2180562       142.22
       9.927     0.993750      2182305       160.00
      10.343     0.994531      2183991       182.86
      10.807     0.995313      2185713       213.33
      11.399     0.996094      2187433       256.00
      11.735     0.996484      2188282       284.44
      12.151     0.996875      2189152       320.00
      12.607     0.997266      2190009       365.71
      13.111     0.997656      2190856       426.67
      13.735     0.998047      2191718       512.00
      14.095     0.998242      2192139       568.89
      14.543     0.998437      2192571       640.00
      15.063     0.998633      2192996       731.43
      15.719     0.998828      2193426       853.33
      16.463     0.999023      2193854      1024.00
      16.863     0.999121      2194069      1137.78
      17.343     0.999219      2194287      1280.00
      17.935     0.999316      2194498      1462.86
      18.623     0.999414      2194713      1706.67
      19.263     0.999512      2194928      2048.00
      19.695     0.999561      2195036      2275.56
      20.111     0.999609      2195144      2560.00
      20.559     0.999658      2195251      2925.71
      21.167     0.999707      2195356      3413.33
      21.887     0.999756      2195463      4096.00
      22.335     0.999780      2195516      4551.11
      22.959     0.999805      2195570      5120.00
      23.519     0.999829      2195624      5851.43
      23.983     0.999854      2195679      6826.67
      24.479     0.999878      2195730      8192.00
      24.863     0.999890      2195758      9102.22
      25.391     0.999902      2195784     10240.00
      25.759     0.999915      2195811     11702.86
      26.127     0.999927      2195840     13653.33
      26.495     0.999939      2195864     16384.00
      26.783     0.999945      2195878     18204.44
      27.215     0.999951      2195891     20480.00
      27.711     0.999957      2195905     23405.71
      28.031     0.999963      2195918     27306.67
      28.415     0.999969      2195931     32768.00
      28.543     0.999973      2195939     36408.89
      28.783     0.999976      2195945     40960.00
      29.279     0.999979      2195952     46811.43
      29.455     0.999982      2195958     54613.33
      29.887     0.999985      2195965     65536.00
      30.047     0.999986      2195968     72817.78
      30.239     0.999988      2195972     81920.00
      30.367     0.999989      2195975     93622.86
      30.559     0.999991      2195979    109226.67
      30.767     0.999992      2195983    131072.00
      30.767     0.999993      2195983    145635.56
      30.847     0.999994      2195985    163840.00
      31.039     0.999995      2195987    187245.71
      31.087     0.999995      2195988    218453.33
      31.279     0.999996      2195990    262144.00
      31.391     0.999997      2195991    291271.11
      31.487     0.999997      2195992    327680.00
      31.663     0.999997      2195993    374491.43
      31.663     0.999998      2195993    436906.67
      31.823     0.999998      2195994    524288.00
      31.951     0.999998      2195995    582542.22
      31.951     0.999998      2195995    655360.00
      32.143     0.999999      2195996    748982.86
      32.143     0.999999      2195996    873813.33
      32.143     0.999999      2195996   1048576.00
      32.271     0.999999      2195997   1165084.44
      32.271     0.999999      2195997   1310720.00
      32.271     0.999999      2195997   1497965.71
      32.271     0.999999      2195997   1747626.67
      32.271     1.000000      2195997   2097152.00
      33.663     1.000000      2195998   2330168.89
      33.663     1.000000      2195998          inf
[Mean    =        1.481, StdDeviation   =        1.526]  
[Max     =       33.632, Total count    =      2195998]    
[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------  
2398088 requests in 2.00m, 153.23MB read  
Requests/sec:  19983.99  
Transfer/sec:      1.28MB

----


./profiler.sh -d 90 -e lock -f hw3lock_get.html 712  
./profiler.sh -d 90 -e alloc -f hw3alloc_get.html 712  
./profiler.sh -d 90 -f hw3cpu_get.html 712

# GET

По наполненной базе

root@DESKTOP-E01FUOQ:~/wrk2# wrk -c 120 -t 3 -d 2m -R 20000 -L -s get.lua http://localhost:8080  
Running 2m test @ http://localhost:8080  
3 threads and 120 connections  
Thread calibration: mean lat.: 2.763ms, rate sampling interval: 10ms  
Thread calibration: mean lat.: 2.846ms, rate sampling interval: 10ms  
Thread calibration: mean lat.: 3.218ms, rate sampling interval: 11ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     2.33ms    3.23ms  46.75ms   90.43%  
Req/Sec     7.08k     1.70k   26.00k    85.25%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    1.35ms  
75.000%    2.00ms  
90.000%    5.32ms  
99.000%   17.07ms  
99.900%   26.08ms  
99.990%   33.44ms  
99.999%   40.32ms  
100.000%   46.78ms

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)

       0.064     0.000000            1         1.00
       0.541     0.100000       219655         1.11
       0.749     0.200000       440297         1.25
       0.942     0.300000       659082         1.43
       1.136     0.400000       878622         1.67
       1.346     0.500000      1098914         2.00
       1.454     0.550000      1208414         2.22
       1.562     0.600000      1317975         2.50
       1.677     0.650000      1427700         2.86
       1.814     0.700000      1537791         3.33
       2.001     0.750000      1647384         4.00
       2.133     0.775000      1702114         4.44
       2.321     0.800000      1756838         5.00
       2.631     0.825000      1811823         5.71
       3.195     0.850000      1866593         6.67
       4.085     0.875000      1921535         8.00
       4.655     0.887500      1949103         8.89
       5.315     0.900000      1976528        10.00
       6.071     0.912500      2003868        11.43
       6.931     0.925000      2031296        13.33
       7.963     0.937500      2058755        16.00
       8.559     0.943750      2072612        17.78
       9.207     0.950000      2086251        20.00
       9.935     0.956250      2100032        22.86
      10.751     0.962500      2113713        26.67
      11.695     0.968750      2127425        32.00
      12.231     0.971875      2134338        35.56
      12.807     0.975000      2141176        40.00
      13.455     0.978125      2147973        45.71
      14.191     0.981250      2154860        53.33
      15.063     0.984375      2161731        64.00
      15.543     0.985938      2165155        71.11
      16.079     0.987500      2168551        80.00
      16.687     0.989062      2172063        91.43
      17.343     0.990625      2175438       106.67
      18.127     0.992188      2178861       128.00
      18.591     0.992969      2180581       142.22
      19.087     0.993750      2182302       160.00
      19.647     0.994531      2183997       182.86
      20.303     0.995313      2185735       213.33
      21.007     0.996094      2187432       256.00
      21.455     0.996484      2188274       284.44
      21.903     0.996875      2189139       320.00
      22.399     0.997266      2190005       365.71
      22.975     0.997656      2190848       426.67
      23.695     0.998047      2191712       512.00
      24.079     0.998242      2192157       568.89
      24.479     0.998437      2192561       640.00
      24.975     0.998633      2193001       731.43
      25.583     0.998828      2193423       853.33
      26.143     0.999023      2193846      1024.00
      26.479     0.999121      2194069      1137.78
      26.895     0.999219      2194281      1280.00
      27.311     0.999316      2194494      1462.86
      27.887     0.999414      2194706      1706.67
      28.399     0.999512      2194920      2048.00
      28.719     0.999561      2195029      2275.56
      29.135     0.999609      2195134      2560.00
      29.535     0.999658      2195240      2925.71
      29.951     0.999707      2195349      3413.33
      30.527     0.999756      2195456      4096.00
      30.815     0.999780      2195510      4551.11
      31.103     0.999805      2195563      5120.00
      31.519     0.999829      2195615      5851.43
      32.063     0.999854      2195669      6826.67
      32.735     0.999878      2195723      8192.00
      33.087     0.999890      2195751      9102.22
      33.503     0.999902      2195777     10240.00
      33.823     0.999915      2195803     11702.86
      34.431     0.999927      2195830     13653.33
      34.847     0.999939      2195856     16384.00
      35.359     0.999945      2195872     18204.44
      35.615     0.999951      2195885     20480.00
      35.935     0.999957      2195898     23405.71
      36.127     0.999963      2195910     27306.67
      36.607     0.999969      2195924     32768.00
      37.183     0.999973      2195931     36408.89
      37.599     0.999976      2195937     40960.00
      37.855     0.999979      2195944     46811.43
      38.143     0.999982      2195951     54613.33
      38.751     0.999985      2195957     65536.00
      39.071     0.999986      2195960     72817.78
      39.647     0.999988      2195964     81920.00
      40.287     0.999989      2195967     93622.86
      40.383     0.999991      2195970    109226.67
      40.927     0.999992      2195974    131072.00
      40.991     0.999993      2195975    145635.56
      41.247     0.999994      2195977    163840.00
      41.375     0.999995      2195979    187245.71
      41.407     0.999995      2195980    218453.33
      41.887     0.999996      2195982    262144.00
      41.983     0.999997      2195983    291271.11
      42.079     0.999997      2195984    327680.00
      42.559     0.999997      2195985    374491.43
      42.559     0.999998      2195985    436906.67
      44.511     0.999998      2195986    524288.00
      44.895     0.999998      2195987    582542.22
      44.895     0.999998      2195987    655360.00
      45.791     0.999999      2195988    748982.86
      45.791     0.999999      2195988    873813.33
      45.791     0.999999      2195988   1048576.00
      46.303     0.999999      2195989   1165084.44
      46.303     0.999999      2195989   1310720.00
      46.303     0.999999      2195989   1497965.71
      46.303     0.999999      2195989   1747626.67
      46.303     1.000000      2195989   2097152.00
      46.783     1.000000      2195990   2330168.89
      46.783     1.000000      2195990          inf
[Mean    =        2.326, StdDeviation   =        3.230]  
[Max     =       46.752, Total count    =      2195990]  
[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------  
2398082 requests in 2.00m, 168.89MB read  
Requests/sec:  19983.94  
Transfer/sec:      1.41MB


# ВЫВОДЫ:

После вынесения обработки запросов, уменьшилась максимальная задержка как при put'e, так и при get'e. Теперь есть общая
очередь для запросов, которую обрабатывает executor, если очередь заполнилась, то выдается ответ, что сервис Unavailable.

Locks: И при put'e и при get'e можно заметить, что есть lock у очереди BlockingQueue. Появляются они в основном, когда очередь заполняется,
т.к поступает очень много запросов.

Cpu's:
В put'e видно, что вся обработка вынесена в потоки.
В get'e видно, что 90% работы выполняется в других потоках.

Allocs:
По аллокациям ситуация похожа, все по 20% всей памяти аллоцируется в других потока, при парсинге запроса. Ну и в основном
память выделяется в потоках, которые уже обрабатывают запрос и отдают ответ

Была идея, где есть общая очередь и потоки крутятся в while(true) и берут задачи из общей очереди. Разницы
особо нет. Показывает практически одинаковые значения, но из-за самого этого цикла возникили сомнения.

## Put:
[cpu_put](hw33cpu_put.html)
[alloc_put](hw33alloc_put.html)
[lock_put](hw33lock_put.html)


## Get:
[cpu_get](hw33cpu_get.html)
[alloc_get](hw33alloc_get.html)
[lock_get](hw33lock_get.html)

Сравнение:

До PUT(rate = 25k)                                                 После(rate = 25k)
Thread Stats   Avg      Stdev     Max   +/- Stdev                  Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     1.61ms    1.71ms  36.16ms   94.21%                     Latency     1.48ms    1.53ms  33.63ms   93.44%
Req/Sec     8.81k     1.46k   30.70k    87.62%                     Req/Sec     7.04k     1.07k   23.67k    87.62%
Latency Distribution (HdrHistogram - Recorded Latency)             Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    1.28ms                                                  50.000%    1.17ms
75.000%    1.81ms                                                  75.000%    1.65ms
90.000%    2.51ms                                                  90.000%    2.30ms
99.000%    9.58ms                                                  99.000%    8.47ms
99.900%   19.97ms                                                  99.900%   16.38ms
99.990%   27.73ms                                                  99.990%   25.26ms
99.999%   32.03ms                                                  99.999%   30.42ms
100.000%   36.19ms                                                 100.000%   33.66ms  

ДО GET(rate = 20000)                                             После(rate = 20000)  

Thread Stats   Avg      Stdev     Max   +/- Stdev                 Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency     1.69ms    1.72ms  35.36ms   92.95%                    Latency     2.33ms    3.23ms  46.75ms   90.43%
Req/Sec     8.82k     1.55k   30.56k    86.64%                    Req/Sec     7.08k     1.70k   26.00k    85.25%
Latency Distribution (HdrHistogram - Recorded Latency)            Latency Distribution (HdrHistogram - Recorded Latency)
50.000%    1.31ms                                                 50.000%    1.35ms
75.000%    1.86ms                                                 75.000%    2.00ms
90.000%    2.75ms                                                 90.000%    5.32ms
99.000%    9.79ms                                                 99.000%   17.07ms
99.900%   17.71ms                                                 99.900%   26.08ms
99.990%   25.63ms                                                 99.990%   33.44ms
99.999%   32.05ms                                                 99.999%   40.32ms
100.000%   35.39ms                                                100.000%   46.78ms  

Если сравнивать, то put не изменился, переход на порядок так же происходит 3х девятках.
Если сравнивать get, то тут переход стал на 99 вместо 99.9. Это связано с тем, что get очень быстро заполняет очередь 
задач, они все идут и идут(задачи). С Put'ом же другая история, там практически нет дорогих операций, значение помещается
в мапу, после чего редко происходят флаши(переход с 2х девяток на 3). Get'у же приходится ходить по диску, поэтому это
не очень быстрая задача, хотя и используется бинарный поиск ключа, с которого читать.  

Так же максимальный rate Get: до(25к), после (20к), то, какие рейты выдерживает.
у Put максимальный rate: до(50k), после(50к). Опять же, при гет забивается очередь. пут операция подешевле.  


После убирания обработки request'ов в отдельном потоке, когда очередь переполняется были получены следующие результаты,
теперь 30к rate выдерживается, больше, чем до ассинхронного варианта. До этого было: если очередь переполнялась, 
то response(unavailable) отправлялся в другом потоке,
теперь же отправляется в том же потоке, т.к кажется, что эта операция выполнится быстро, нет смысла ее выносить в другой 
поток    

root@DESKTOP-E01FUOQ:~/wrk2# wrk -c 120 -t 3 -d 2m -R 30000 -L -s get.lua http://localhost:8080  
Running 2m test @ http://localhost:8080  
3 threads and 120 connections  
Thread calibration: mean lat.: 4.587ms, rate sampling interval: 19ms  
Thread calibration: mean lat.: 4.443ms, rate sampling interval: 19ms  
Thread calibration: mean lat.: 4.938ms, rate sampling interval: 20ms  
Thread Stats   Avg      Stdev     Max   +/- Stdev  
Latency     4.79ms    4.88ms  85.06ms   89.39%  
Req/Sec    10.32k     2.05k   25.84k    78.50%  
Latency Distribution (HdrHistogram - Recorded Latency)  
50.000%    3.33ms  
75.000%    5.45ms  
90.000%   10.03ms  
99.000%   24.75ms  
99.900%   44.06ms  
99.990%   66.82ms  
99.999%   78.01ms  
100.000%   85.12ms  

Detailed Percentile spectrum:  
Value   Percentile   TotalCount 1/(1-Percentile)  

       0.072     0.000000            1         1.00
       1.296     0.100000       329670         1.11
       1.810     0.200000       659345         1.25
       2.291     0.300000       988773         1.43
       2.775     0.400000      1318325         1.67
       3.325     0.500000      1647296         2.00
       3.629     0.550000      1812154         2.22
       3.977     0.600000      1976943         2.50
       4.363     0.650000      2141391         2.86
       4.839     0.700000      2305957         3.33
       5.451     0.750000      2470552         4.00
       5.843     0.775000      2553406         4.44
       6.315     0.800000      2635369         5.00
       6.915     0.825000      2717493         5.71
       7.691     0.850000      2799966         6.67
       8.711     0.875000      2882306         8.00
       9.327     0.887500      2923524         8.89
      10.031     0.900000      2964636        10.00
      10.831     0.912500      3005943        11.43
      11.751     0.925000      3046839        13.33
      12.847     0.937500      3088088        16.00
      13.495     0.943750      3108796        17.78
      14.215     0.950000      3129207        20.00
      15.039     0.956250      3149768        22.86
      15.983     0.962500      3170362        26.67
      17.119     0.968750      3190916        32.00
      17.791     0.971875      3201429        35.56
      18.527     0.975000      3211611        40.00
      19.375     0.978125      3221851        45.71
      20.383     0.981250      3232170        53.33
      21.615     0.984375      3242495        64.00
      22.335     0.985938      3247564        71.11
      23.167     0.987500      3252736        80.00
      24.127     0.989062      3257894        91.43
      25.215     0.990625      3262987       106.67
      26.511     0.992188      3268168       128.00
      27.279     0.992969      3270744       142.22
      28.095     0.993750      3273274       160.00
      29.071     0.994531      3275873       182.86
      30.175     0.995313      3278429       213.33
      31.567     0.996094      3281002       256.00
      32.415     0.996484      3282283       284.44
      33.375     0.996875      3283572       320.00
      34.495     0.997266      3284856       365.71
      35.807     0.997656      3286144       426.67
      37.503     0.998047      3287434       512.00
      38.495     0.998242      3288060       568.89
      39.775     0.998437      3288715       640.00
      41.087     0.998633      3289350       731.43
      42.559     0.998828      3289992       853.33
      44.255     0.999023      3290638      1024.00
      45.375     0.999121      3290954      1137.78
      46.591     0.999219      3291286      1280.00
      47.807     0.999316      3291599      1462.86
      49.279     0.999414      3291920      1706.67
      51.359     0.999512      3292246      2048.00
      52.415     0.999561      3292401      2275.56
      53.951     0.999609      3292566      2560.00
      55.679     0.999658      3292731      2925.71
      57.951     0.999707      3292885      3413.33
      60.415     0.999756      3293046      4096.00
      61.407     0.999780      3293125      4551.11
      62.303     0.999805      3293206      5120.00
      63.263     0.999829      3293286      5851.43
      64.511     0.999854      3293366      6826.67
      65.503     0.999878      3293446      8192.00
      66.239     0.999890      3293487      9102.22
      66.879     0.999902      3293528     10240.00
      67.647     0.999915      3293570     11702.86
      68.479     0.999927      3293608     13653.33
      69.567     0.999939      3293648     16384.00
      70.015     0.999945      3293669     18204.44
      70.847     0.999951      3293690     20480.00
      71.615     0.999957      3293708     23405.71
      72.831     0.999963      3293729     27306.67
      73.791     0.999969      3293750     32768.00
      74.239     0.999973      3293758     36408.89
      74.751     0.999976      3293768     40960.00
      75.199     0.999979      3293779     46811.43
      75.775     0.999982      3293788     54613.33
      76.863     0.999985      3293798     65536.00
      77.119     0.999986      3293804     72817.78
      77.567     0.999988      3293808     81920.00
      77.759     0.999989      3293813     93622.86
      78.591     0.999991      3293819    109226.67
      78.847     0.999992      3293823    131072.00
      79.103     0.999993      3293827    145635.56
      79.167     0.999994      3293828    163840.00
      79.679     0.999995      3293831    187245.71
      79.807     0.999995      3293833    218453.33
      80.319     0.999996      3293836    262144.00
      80.575     0.999997      3293837    291271.11
      81.215     0.999997      3293838    327680.00
      82.623     0.999997      3293840    374491.43
      82.943     0.999998      3293841    436906.67
      83.071     0.999998      3293842    524288.00
      83.711     0.999998      3293843    582542.22
      83.711     0.999998      3293843    655360.00
      83.775     0.999999      3293844    748982.86
      84.159     0.999999      3293845    873813.33
      84.159     0.999999      3293845   1048576.00
      84.479     0.999999      3293846   1165084.44
      84.479     0.999999      3293846   1310720.00
      84.479     0.999999      3293846   1497965.71
      84.991     0.999999      3293847   1747626.67
      84.991     1.000000      3293847   2097152.00
      84.991     1.000000      3293847   2330168.89
      84.991     1.000000      3293847   2621440.00
      84.991     1.000000      3293847   2995931.43
      85.119     1.000000      3293848   3495253.33
      85.119     1.000000      3293848          inf
[Mean    =        4.786, StdDeviation   =        4.882]
[Max     =       85.056, Total count    =      3293848]
[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
3597007 requests in 2.00m, 254.07MB read  
Requests/sec:  29975.11  
Transfer/sec:      2.12MB  